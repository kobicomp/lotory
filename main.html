<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××—×•×œ×œ ×”×’×¨×œ×•×ª ××ª×§×“× ×¢× ××¤×§×˜×™× ×•×™×–×•××œ×™×™×</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap');

    * {
      box-sizing: border-box;
      font-family: 'Rubik', 'Segoe UI', Arial, sans-serif;
    }

    body {
      background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
      margin: 0;
      padding: 20px;
      direction: rtl;
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(13, 17, 23, 0.9);
      border-radius: 20px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      padding: 30px;
      position: relative;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    h1 {
      color: #fff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 48px;
      position: relative;
      text-shadow: 0 0 20px rgba(79, 195, 247, 0.8);
      z-index: 1;
    }

    h1 span {
      background: linear-gradient(45deg, #4FC3F7, #E040FB, #FFC107);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: inline-block;
      animation: textShimmer 3s infinite;
      background-size: 200% 200%;
    }

    @keyframes textShimmer {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(45deg, #4FC3F7, #00B0FF);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(79, 195, 247, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 195, 247, 0.4);
    }

    .btn-danger {
      background: linear-gradient(45deg, #FF5722, #F44336);
      box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3);
    }

    .btn-success {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-warning {
      background: linear-gradient(45deg, #FF9800, #F57C00);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    /* ××–×•×¨ ×”×›× ×¡×ª ××©×ª×ª×¤×™× ×™×“× ×™ */
    .manual-input-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .input-section {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      margin-bottom: 20px;
      align-items: end;
    }

    .manual-textarea {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      color: white;
      font-size: 14px;
      min-height: 150px;
      resize: vertical;
      width: 100%;
    }

    .manual-textarea:focus {
      outline: none;
      border-color: #4FC3F7;
      box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
    }

    .manual-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* ×ª×¦×•×’×ª ××©×ª×ª×¤×™× ××§×•×•× ×ª */
    .participants-display {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .participant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }

    .participant-card {
      background: rgba(79, 195, 247, 0.1);
      border: 1px solid rgba(79, 195, 247, 0.3);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s;
      position: relative;
    }

    .participant-card.winner {
      background: rgba(255, 193, 7, 0.2);
      border-color: #FFC107;
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
    }

    .participant-number {
      position: absolute;
      top: 5px;
      left: 8px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
    }

    .participant-name {
      font-weight: 600;
      font-size: 14px;
      margin-top: 10px;
    }

    /* ×§× ×‘×¡ ×”×ª×œ×ª-×××“ */
    .canvas-container {
      position: relative;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 15px;
      margin: 20px 0;
      min-height: 400px;
      border: 2px solid rgba(79, 195, 247, 0.3);
      overflow: hidden;
    }

    #main-canvas {
      width: 100%;
      height: 400px;
      display: block;
      border-radius: 15px;
    }

    .canvas-overlay {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      pointer-events: none;
      z-index: 10;
    }

    .age-selector {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .age-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      flex: 1;
      min-width: 150px;
      border: 2px solid transparent;
    }

    .age-card:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .age-card.selected {
      border-color: #4FC3F7;
      background: rgba(79, 195, 247, 0.2);
    }

    .effect-selector {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }

    .effect-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      min-width: 150px;
      border: 2px solid transparent;
    }

    .effect-card:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-5px);
    }

    .effect-card.selected {
      border-color: #4FC3F7;
      box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    }

    .effect-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(45deg, #4FC3F7, #E040FB);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 5px;
    }

    .controls-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .control-label {
      min-width: 150px;
      font-weight: 600;
    }

    input, select, textarea {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-size: 14px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4FC3F7;
      box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
    }

    .file-upload-area {
      border: 2px dashed rgba(79, 195, 247, 0.5);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload-area:hover {
      border-color: #4FC3F7;
      background: rgba(79, 195, 247, 0.1);
    }

    .file-upload-area.dragover {
      border-color: #E040FB;
      background: rgba(224, 64, 251, 0.1);
    }

    .winners-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .winner-item {
      background: rgba(255, 193, 7, 0.1);
      border-right: 4px solid #FFC107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .winner-number {
      background: linear-gradient(135deg, #FFC107, #FF5722);
      color: #000;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }

    .draw-button {
      background: linear-gradient(45deg, #FF6D00, #FFAB00);
      border: none;
      border-radius: 20px;
      padding: 20px 40px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 20px auto;
      min-width: 300px;
      transition: all 0.3s;
      box-shadow: 0 10px 30px rgba(255, 109, 0, 0.4);
    }

    .draw-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255, 109, 0, 0.6);
    }

    .draw-button:disabled {
      background: linear-gradient(45deg, #666, #999);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ××¡×š ×”×’×¨×œ×” ×‘××¡×š ××œ× */
    .fullscreen-stage {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s;
      overflow: hidden;
    }

    .fullscreen-stage.active {
      opacity: 1;
      visibility: visible;
    }

    #stage-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .stage-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .stage-title {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 42px;
      font-weight: bold;
      text-align: center;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
      animation: titlePulse 2s infinite;
      z-index: 20;
    }

    @keyframes titlePulse {
      0% { text-shadow: 0 0 30px rgba(79, 195, 247, 0.8); }
      50% { text-shadow: 0 0 50px rgba(224, 64, 251, 0.8); }
      100% { text-shadow: 0 0 30px rgba(79, 195, 247, 0.8); }
    }

    .stage-progress {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      z-index: 20;
    }

    .stage-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4FC3F7, #E040FB);
      width: 0%;
      transition: width 0.3s;
    }

    .stage-controls {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 20;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn-group {
        justify-content: center;
      }
      
      #main-canvas {
        height: 300px;
      }
      
      .stage-title {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span>××—×•×œ×œ ×”×’×¨×œ×•×ª ××ª×§×“×</span> ×¢× ××¤×§×˜×™×</h1>
    
    <!-- ×¡×¨×’×œ ×›×œ×™× ×¢×œ×™×•×Ÿ -->
    <div class="toolbar">
      <div class="btn-group">
        <button class="btn" id="btnLoadFile">ğŸ“ ×˜×¢×Ÿ ×§×•×‘×¥</button>
        <button class="btn btn-warning" id="btnRandomize">ğŸ”„ ×¢×¨×‘×‘</button>
        <button class="btn btn-success" id="btnFullscreen">â›¶ ××¡×š ××œ×</button>
      </div>
      <div class="btn-group">
        <button class="btn btn-danger" id="btnReset">ğŸ—‘ï¸ ××™×¤×•×¡</button>
        <button class="btn" id="btnExport">ğŸ“Š ×™×™×¦×•×</button>
      </div>
    </div>

    <!-- ×‘×—×™×¨×ª ×§×‘×•×¦×ª ×’×™×œ -->
    <div class="age-selector">
      <div class="age-card selected" data-age="primary">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸˆ</div>
        <div style="font-weight: bold;">×™×¡×•×“×™</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×’×™×œ××™ 6-11</div>
      </div>
      <div class="age-card" data-age="middle">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸš€</div>
        <div style="font-weight: bold;">×—×˜×™×‘×ª ×‘×™× ×™×™×</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×’×™×œ××™ 12-15</div>
      </div>
      <div class="age-card" data-age="high">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“</div>
        <div style="font-weight: bold;">×ª×™×›×•×Ÿ</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×’×™×œ××™ 16-18</div>
      </div>
    </div>

    <!-- ×”×›× ×¡×ª ××©×ª×ª×¤×™× ×™×“× ×™×ª -->
    <div class="manual-input-panel">
      <h3 style="margin-top: 0;">âœï¸ ×”×›× ×¡×ª ××©×ª×ª×¤×™×</h3>
      
      <div class="input-section">
        <div>
          <label for="manualInput" style="display: block; margin-bottom: 10px; font-weight: 600;">
            ×”×–×Ÿ ×©××•×ª ×”××©×ª×ª×¤×™× (×›×œ ×©× ×‘×©×•×¨×” × ×¤×¨×“×ª):
          </label>
          <textarea 
            id="manualInput" 
            class="manual-textarea" 
            placeholder="×“×•×’××”:&#10;×™×•×¡×™ ×›×”×Ÿ&#10;×©×¨×” ×œ×•×™&#10;×“× ×™ ×’×•×œ×Ÿ&#10;××™×›×œ ×¨×•×–×Ÿ&#10;&#10;××• ×œ×—×¥ ×¤×¢××™×™× ×œ×”×•×¡×¤×ª ×“×•×’××” ××”×™×¨×”"
          ></textarea>
        </div>
        <div>
          <button class="btn btn-success" id="btnAddParticipants">â• ×”×•×¡×£ ××©×ª×ª×¤×™×</button>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="btn" id="btnSampleData">ğŸ“ ×“×•×’××” ××”×™×¨×”</button>
        <button class="btn btn-warning" id="btnClearInput">ğŸ—‘ï¸ × ×§×” ×”×©×“×”</button>
        <button class="btn btn-danger" id="btnClearAll">âŒ × ×§×” ×”×›×œ</button>
      </div>
    </div>

    <!-- ××–×•×¨ ×”×¢×œ××ª ×§×‘×¦×™× -->
    <div class="file-upload-area" id="fileUploadArea">
      <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
      <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">××• ×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.7);">×ª××™×›×” ×‘: CSV, TXT, XLSX</div>
      <input type="file" id="fileInput" accept=".csv,.txt,.xlsx" style="display: none;">
    </div>

    <!-- ×”×¦×’×ª ××©×ª×ª×¤×™× -->
    <div class="participants-display" id="participantsDisplay" style="display: none;">
      <h3 style="margin-top: 0;">ğŸ‘¥ ×¨×©×™××ª ××©×ª×ª×¤×™× (<span id="participantCount">0</span>)</h3>
      <div class="participant-grid" id="participantGrid"></div>
    </div>

    <!-- ×‘×—×™×¨×ª ××¤×§×˜ ×•×™×–×•××œ×™ -->
    <div class="effect-selector">
      <div class="effect-card selected" data-effect="classroom">
        <div class="effect-icon">ğŸ«</div>
        <div style="font-weight: bold;">×›×™×ª×” ×§×¡×•××”</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×›×™×¡××•×ª ×–×•×”×¨×™×</div>
      </div>
      <div class="effect-card" data-effect="space">
        <div class="effect-icon">ğŸš€</div>
        <div style="font-weight: bold;">××¡×¢ ×‘×—×œ×œ</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×›×•×›×‘×™× ×•×’×œ×§×¡×™×•×ª</div>
      </div>
      <div class="effect-card" data-effect="magic">
        <div class="effect-icon">ğŸ§ª</div>
        <div style="font-weight: bold;">××¢×‘×“×ª ×§×¡××™×</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×‘×§×‘×•×§×™ ×©×™×§×•×™</div>
      </div>
      <div class="effect-card" data-effect="adventure">
        <div class="effect-icon">âš”ï¸</div>
        <div style="font-weight: bold;">×”×¨×¤×ª×§×ª ×œ×•×—××™×</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×©×“×” ×§×¨×‘ ××¤×™</div>
      </div>
      <div class="effect-card" data-effect="nature">
        <div class="effect-icon">ğŸŒ²</div>
        <div style="font-weight: bold;">×™×¢×¨ ××›×•×©×£</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">×¢×¦×™× ×•×¤×™×•×ª</div>
      </div>
    </div>

    <!-- ×§× ×‘×¡ ×”×ª×œ×ª-×××“ -->
    <div class="canvas-container">
      <canvas id="main-canvas"></canvas>
      <div class="canvas-overlay" id="canvasInfo">
        <div>××¤×§×˜ × ×•×›×—×™: <span id="currentEffectName">×›×™×ª×” ×§×¡×•××”</span></div>
        <div>××©×ª×ª×¤×™×: <span id="canvasParticipantCount">0</span></div>
        <div>×–×•×›×™×: <span id="canvasWinnerCount">0</span></div>
      </div>
    </div>

    <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
    <div class="stats-panel">
      <div class="stat-card">
        <div class="stat-value" id="totalParticipants">0</div>
        <div class="stat-label">×¡×š ×”×›×œ ××©×ª×ª×¤×™×</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="availableParticipants">0</div>
        <div class="stat-label">××©×ª×ª×¤×™× ×–××™× ×™×</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalWinners">0</div>
        <div class="stat-label">×¡×š ×”×›×œ ×–×•×›×™×</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="currentRound">0</div>
        <div class="stat-label">×¡×™×‘×•×‘ × ×•×›×—×™</div>
      </div>
    </div>

    <!-- ×¤×× ×œ ×‘×§×¨×” -->
    <div class="controls-panel">
      <h3 style="margin-top: 0;">ğŸ® ×‘×§×¨×ª ×”×’×¨×œ×”</h3>
      
      <div class="control-group">
        <label class="control-label">×©× ×”×”×’×¨×œ×”:</label>
        <input type="text" id="drawName" placeholder="×œ×“×•×’××”: ××™ ×™×¢× ×” ×¢×œ ×”×©××œ×” ×”×‘××”?" style="flex: 1;">
      </div>
      
      <div class="control-group">
        <label class="control-label">××¡×¤×¨ ×–×•×›×™×:</label>
        <input type="number" id="winnersCount" min="1" max="100" value="1" style="width: 100px;">
        <label class="control-label">××”×™×¨×•×ª ×”×’×¨×œ×”:</label>
        <select id="drawSpeed" style="width: 150px;">
          <option value="fast">××”×™×¨ (5 ×©× ×™×•×ª)</option>
          <option value="normal" selected>×¨×’×™×œ (10 ×©× ×™×•×ª)</option>
          <option value="dramatic">×“×¨××˜×™ (20 ×©× ×™×•×ª)</option>
          <option value="epic">××¤×™ (30 ×©× ×™×•×ª)</option>
        </select>
      </div>
      
      <div class="control-group">
        <label class="control-label">×”×¦×’ ×©××•×ª:</label>
        <select id="nameDisplay">
          <option value="full">×©××•×ª ××œ××™×</option>
          <option value="first">×©× ×¤×¨×˜×™ ×‘×œ×‘×“</option>
          <option value="initials">×¨××©×™ ×ª×™×‘×•×ª</option>
          <option value="numbers">××¡×¤×¨×™× ×‘×œ×‘×“</option>
        </select>
        <label class="control-label">××¤×©×¨ ×–×›×™×™×” ×—×•×–×¨×ª:</label>
        <select id="allowRepeat">
          <option value="false" selected>×œ×</option>
          <option value="true">×›×Ÿ</option>
        </select>
      </div>
    </div>

    <!-- ×›×¤×ª×•×¨ ×”×’×¨×œ×” ×¨××©×™ -->
    <button class="draw-button" id="mainDrawButton" disabled>
      <span style="font-size: 32px;">ğŸ²</span>
      <span>×”×’×¨×œ ×¢×›×©×™×•!</span>
    </button>

    <!-- ×¤×× ×œ ×–×•×›×™× -->
    <div class="winners-panel">
      <h3 style="margin-top: 0;">ğŸ† ×–×•×›×™ ×”×”×’×¨×œ×”</h3>
      <div id="winnersList"></div>
    </div>
  </div>

  <!-- ××¡×š ×”×’×¨×œ×” ×‘××¡×š ××œ× -->
  <div class="fullscreen-stage" id="fullscreenStage">
    <canvas id="stage-canvas"></canvas>
    <div class="stage-overlay">
      <div class="stage-title" id="stageTitle">××›×™× ×™× ××ª ×”×”×’×¨×œ×”...</div>
      <div class="stage-progress">
        <div class="stage-progress-bar" id="stageProgressBar"></div>
      </div>
      <div class="stage-controls">
        <button class="btn" id="pauseButton">â¸ï¸ ×”×©×”×”</button>
        <button class="btn btn-danger" id="stopButton">â¹ï¸ ×¢×¦×•×¨</button>
        <button class="btn" id="exitStageButton">âŒ ×™×¦×™××”</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    class AdvancedLotterySystem {
      constructor() {
        this.participants = [];
        this.availableParticipants = [];
        this.winners = [];
        this.currentEffect = 'classroom';
        this.currentAge = 'primary';
        this.isDrawing = false;
        this.isPaused = false;
        
        // ×× ×•×¢ ×ª×œ×ª-×××“
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.stageScene = null;
        this.stageCamera = null;
        this.stageRenderer = null;
        this.participantObjects = [];
        this.animationId = null;
        
        // ××•×“×™×•
        this.audioContext = null;
        
        this.initializeAudio();
        this.initializeThreeJS();
        this.bindEvents();
        this.animate();
      }

      initializeAudio() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log('Audio not supported');
        }
      }

      initializeThreeJS() {
        // ×§× ×‘×¡ ×¨××©×™
        const canvas = document.getElementById('main-canvas');
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        this.renderer.setClearColor(0x000011, 1);
        
        // ×§× ×‘×¡ ××¡×š ××œ×
        const stageCanvas = document.getElementById('stage-canvas');
        this.stageScene = new THREE.Scene();
        this.stageCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.stageRenderer = new THREE.WebGLRenderer({ canvas: stageCanvas, antialias: true });
        this.stageRenderer.setSize(window.innerWidth, window.innerHeight);
        this.stageRenderer.setClearColor(0x000011, 1);
        
        // ×”×’×“×¨×•×ª ××¦×œ××”
        this.camera.position.set(0, 5, 30);
        this.stageCamera.position.set(0, 5, 30);
        
        // ×ª××•×¨×”
        this.addLighting();
        this.addStars();
      }

      addLighting() {
        // ×ª××•×¨×” ×¡×‘×™×‘×ª×™×ª
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        this.scene.add(ambientLight);
        this.stageScene.add(ambientLight.clone());
        
        // ×ª××•×¨×” ×™×©×™×¨×”
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 5);
        this.scene.add(directionalLight);
        this.stageScene.add(directionalLight.clone());
        
        // ×ª××•×¨×ª × ×§×•×“×”
        const pointLight = new THREE.PointLight(0x4FC3F7, 1, 100);
        pointLight.position.set(0, 10, 0);
        this.scene.add(pointLight);
        this.stageScene.add(pointLight.clone());
      }

      addStars() {
        // ×™×¦×™×¨×ª ×›×•×›×‘×™× ×‘×¨×§×¢
        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [];
        
        for (let i = 0; i < 1000; i++) {
          starVertices.push((Math.random() - 0.5) * 200);
          starVertices.push((Math.random() - 0.5) * 200);
          starVertices.push((Math.random() - 0.5) * 200);
        }
        
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 2 });
        const stars = new THREE.Points(starGeometry, starMaterial);
        
        this.scene.add(stars);
        this.stageScene.add(stars.clone());
      }

      bindEvents() {
        // ×›×¤×ª×•×¨×™× ×¨××©×™×™×
        document.getElementById('btnLoadFile').addEventListener('click', () => this.openFileDialog());
        document.getElementById('btnReset').addEventListener('click', () => this.resetLottery());
        document.getElementById('btnFullscreen').addEventListener('click', () => this.enterFullscreen());
        document.getElementById('btnRandomize').addEventListener('click', () => this.randomizePositions());
        
        // ×”×›× ×¡×” ×™×“× ×™×ª
        document.getElementById('btnAddParticipants').addEventListener('click', () => this.addManualParticipants());
        document.getElementById('btnSampleData').addEventListener('click', () => this.loadSampleData());
        document.getElementById('btnClearInput').addEventListener('click', () => this.clearInput());
        document.getElementById('btnClearAll').addEventListener('click', () => this.clearAll());
        
        // ×›×¤×ª×•×¨ ×”×’×¨×œ×” ×¨××©×™
        document.getElementById('mainDrawButton').addEventListener('click', () => this.startDraw());
        
        // ×‘×—×™×¨×ª ×’×™×œ
        document.querySelectorAll('.age-card').forEach(card => {
          card.addEventListener('click', () => this.selectAge(card.dataset.age));
        });
        
        // ×‘×—×™×¨×ª ××¤×§×˜
        document.querySelectorAll('.effect-card').forEach(card => {
          card.addEventListener('click', () => this.selectEffect(card.dataset.effect));
        });
        
        // ×”×¢×œ××ª ×§×‘×¦×™×
        this.setupFileUpload();
        
        // ×‘×§×¨×•×ª ××¡×š ××œ×
        document.getElementById('pauseButton').addEventListener('click', () => this.pauseDraw());
        document.getElementById('stopButton').addEventListener('click', () => this.stopDraw());
        document.getElementById('exitStageButton').addEventListener('click', () => this.exitFullscreen());
        
        // ×§×™×¦×•×¨×™ ××§×œ×“×ª
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        
        // ×œ×—×™×¦×” ×›×¤×•×œ×” ×¢×œ textarea
        document.getElementById('manualInput').addEventListener('dblclick', () => {
          if (document.getElementById('manualInput').value.trim() === '') {
            this.loadSampleData();
          }
        });
        
        // ×”×ª×××” ×œ×©×™× ×•×™ ×’×•×“×œ
        window.addEventListener('resize', () => this.handleResize());
      }

      setupFileUpload() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        
        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadArea.classList.add('dragover');
        });
        fileUploadArea.addEventListener('dragleave', () => {
          fileUploadArea.classList.remove('dragover');
        });
        fileUploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove('dragover');
          this.handleFile(e.dataTransfer.files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            this.handleFile(e.target.files[0]);
          }
        });
      }

      selectAge(age) {
        this.currentAge = age;
        document.querySelectorAll('.age-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelector(`[data-age="${age}"]`).classList.add('selected');
        this.updateVisualization();
      }

      selectEffect(effect) {
        this.currentEffect = effect;
        document.querySelectorAll('.effect-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelector(`[data-effect="${effect}"]`).classList.add('selected');
        
        // ×¢×“×›×•×Ÿ ×©× ×”××¤×§×˜
        const effectNames = {
          classroom: '×›×™×ª×” ×§×¡×•××”',
          space: '××¡×¢ ×‘×—×œ×œ',
          magic: '××¢×‘×“×ª ×§×¡××™×',
          adventure: '×”×¨×¤×ª×§×ª ×œ×•×—××™×',
          nature: '×™×¢×¨ ××›×•×©×£'
        };
        document.getElementById('currentEffectName').textContent = effectNames[effect];
        
        this.updateVisualization();
      }

      loadSampleData() {
        const sampleNames = [
          '×™×•×¡×™ ×›×”×Ÿ', '×©×¨×” ×œ×•×™', '×“× ×™ ×’×•×œ×Ÿ', '××™×›×œ ×¨×•×–×Ÿ', '××œ×™ ×¤×¨×™×“××Ÿ',
          '× ×•×¢×” ×©××™×¨', '×¨×•× ×Ÿ ××‘×¨××•×‘×™×¥', '×ª××¨ ×›×¨××œ', '×¢××¨×™ ×“×•×“', '×œ×™×” ××–×¨×—×™',
          '××¡×£ ×¨×•×Ÿ', '×’×œ×™ ×××™×¨', '×™×•×‘×œ ×©×—×¨', '×”×™×œ×” ×›×”×Ÿ', '××¨×™×” ×œ×•×™×Ÿ',
          '×××™×” ×©×œ×•×', '××™×ª×™ ×’×¨×•×¡', '×¨×•×ª× ×›×¥', '×¢×™×“×Ÿ ×¤×œ×“', '×©× ×™ ×‘×¨',
          '× ×ª×Ÿ ×‘×¨×§', '×™×¢×œ ×©×œ×•×', '××•×¨×™ ×’×•×œ×“×‘×¨×’', '×“× ×” ×××™×¨', '×¨×•×¢×™ ×›×”×Ÿ'
        ];
        
        document.getElementById('manualInput').value = sampleNames.join('\n');
        this.showNotification('×“×•×’××” × ×˜×¢× ×”! ×œ×—×¥ "×”×•×¡×£ ××©×ª×ª×¤×™×"', 'success');
      }

      clearInput() {
        document.getElementById('manualInput').value = '';
      }

      clearAll() {
        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”××©×ª×ª×¤×™×?')) {
          this.participants = [];
          this.availableParticipants = [];
          this.winners = [];
          this.updateAll();
          this.showNotification('×›×œ ×”× ×ª×•× ×™× × ××—×§×•', 'info');
        }
      }

      addManualParticipants() {
        const input = document.getElementById('manualInput').value.trim();
        if (!input) {
          this.showNotification('× × ×œ×”×–×™×Ÿ ×©××•×ª ××©×ª×ª×¤×™×', 'error');
          return;
        }

        const names = input.split('\n')
          .map(name => name.trim())
          .filter(name => name.length > 0);

        if (names.length === 0) {
          this.showNotification('×œ× × ××¦××• ×©××•×ª ×ª×§×™× ×™×', 'error');
          return;
        }

        // ×”×•×¡×¤×ª ×”××©×ª×ª×¤×™×
        const startId = this.participants.length;
        names.forEach((name, index) => {
          const participant = {
            id: startId + index,
            name: name,
            fullName: name,
            originalIndex: startId + index
          };
          this.participants.push(participant);
          this.availableParticipants.push(participant);
        });

        // ×¢×“×›×•×Ÿ ×›×œ ×”×ª×¦×•×’×•×ª
        this.updateAll();
        document.getElementById('manualInput').value = '';
        this.showNotification(`× ×•×¡×¤×• ${names.length} ××©×ª×ª×¤×™×!`, 'success');
      }

      async handleFile(file) {
        if (!file) return;
        
        try {
          let data = '';
          const extension = file.name.split('.').pop().toLowerCase();
          
          if (extension === 'xlsx' || extension === 'xls') {
            data = await this.readExcelFile(file);
          } else {
            data = await this.readTextFile(file);
          }
          
          this.parseParticipants(data);
          this.updateAll();
          this.showNotification('×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!', 'success');
        } catch (error) {
          this.showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message, 'error');
        }
      }

      readTextFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
          reader.readAsText(file, 'UTF-8');
        });
      }

      readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
              const textData = jsonData.map(row => row.join(',')).join('\n');
              resolve(textData);
            } catch (error) {
              reject(new Error('×©×’×™××” ×‘×¤×¢× ×•×— ×§×•×‘×¥ Excel'));
            }
          };
          reader.onerror = () => reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
          reader.readAsArrayBuffer(file);
        });
      }

      parseParticipants(data) {
        const lines = data.split('\n').map(line => line.trim()).filter(line => line);
        this.participants = [];
        
        lines.forEach((line, index) => {
          const parts = line.split(',').map(part => part.trim().replace(/['"]/g, ''));
          const name = parts[0] || `××©×ª×ª×£ ${index + 1}`;
          
          if (name && name.length > 0) {
            this.participants.push({
              id: index,
              name: name,
              fullName: parts.length > 1 ? parts.join(' ') : name,
              originalIndex: index
            });
          }
        });
        
        this.availableParticipants = [...this.participants];
      }

      updateAll() {
        this.updateStats();
        this.updateParticipantsDisplay();
        this.updateVisualization();
        this.updateWinnersList();
        document.getElementById('mainDrawButton').disabled = this.participants.length === 0;
      }

      updateStats() {
        document.getElementById('totalParticipants').textContent = this.participants.length;
        document.getElementById('availableParticipants').textContent = this.availableParticipants.length;
        document.getElementById('totalWinners').textContent = this.winners.length;
        document.getElementById('currentRound').textContent = this.winners.length > 0 ? Math.floor(this.winners.length / parseInt(document.getElementById('winnersCount').value || 1)) + 1 : 0;
        
        // ×¢×“×›×•×Ÿ ×§× ×‘×¡
        document.getElementById('canvasParticipantCount').textContent = this.participants.length;
        document.getElementById('canvasWinnerCount').textContent = this.winners.length;
      }

      updateParticipantsDisplay() {
        const display = document.getElementById('participantsDisplay');
        const grid = document.getElementById('participantGrid');
        const count = document.getElementById('participantCount');
        
        if (this.participants.length === 0) {
          display.style.display = 'none';
          return;
        }
        
        display.style.display = 'block';
        count.textContent = this.participants.length;
        grid.innerHTML = '';
        
        this.participants.forEach(participant => {
          const card = document.createElement('div');
          card.className = 'participant-card';
          card.dataset.id = participant.id;
          
          const isWinner = this.winners.some(winner => winner.id === participant.id);
          if (isWinner) {
            card.classList.add('winner');
          }
          
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          if (!isAvailable && !isWinner) {
            card.style.opacity = '0.5';
          }
          
          card.innerHTML = `
            <div class="participant-number">#${participant.id + 1}</div>
            <div class="participant-name">${this.formatDisplayName(participant.name)}</div>
            ${isWinner ? '<div style="color: #FFC107; margin-top: 5px;">ğŸ†</div>' : ''}
          `;
          
          grid.appendChild(card);
        });
      }

      updateVisualization() {
        // × ×™×§×•×™ ×”×¡×¦× ×”
        this.clearScene();
        
        if (this.participants.length === 0) return;
        
        // ×™×¦×™×¨×ª ×•×™×–×•××œ×™×–×¦×™×” ×œ×¤×™ ×”××¤×§×˜ ×”× ×‘×—×¨
        this.createVisualizationByEffect();
      }

      clearScene() {
        // ×”×¡×¨×ª ×›×œ ×”××•×‘×™×™×§×˜×™× ×¤×¨×˜ ×œ×ª××•×¨×” ×•×›×•×›×‘×™×
        const objectsToRemove = [];
        this.scene.traverse((object) => {
          if (object.userData.isParticipant) {
            objectsToRemove.push(object);
          }
        });
        objectsToRemove.forEach(object => this.scene.remove(object));
        
        // ××™×¤×•×¡ ×¨×©×™××ª ×”××•×‘×™×™×§×˜×™×
        this.participantObjects = [];
      }

      createVisualizationByEffect() {
        switch(this.currentEffect) {
          case 'classroom':
            this.createClassroomEffect();
            break;
          case 'space':
            this.createSpaceEffect();
            break;
          case 'magic':
            this.createMagicEffect();
            break;
          case 'adventure':
            this.createAdventureEffect();
            break;
          case 'nature':
            this.createNatureEffect();
            break;
        }
      }

      createClassroomEffect() {
        const rows = Math.ceil(Math.sqrt(this.participants.length));
        const cols = Math.ceil(this.participants.length / rows);
        const spacing = 3;
        
        this.participants.forEach((participant, index) => {
          const row = Math.floor(index / cols);
          const col = index % cols;
          
          // ×™×¦×™×¨×ª ×›×™×¡×
          const chairGeometry = new THREE.BoxGeometry(1, 1.5, 1);
          const isWinner = this.winners.some(w => w.id === participant.id);
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          
          let chairColor = 0x4FC3F7; // ×›×—×•×œ ×¨×’×™×œ
          if (isWinner) {
            chairColor = 0xFFD700; // ×–×”×‘ ×œ×–×•×›×™×
          } else if (!isAvailable) {
            chairColor = 0x666666; // ××¤×•×¨ ×œ×‘×œ×ª×™ ×–××™× ×™×
          }
          
          const chairMaterial = new THREE.MeshLambertMaterial({ 
            color: chairColor,
            transparent: true,
            opacity: isAvailable || isWinner ? 1.0 : 0.5
          });
          
          const chair = new THREE.Mesh(chairGeometry, chairMaterial);
          chair.position.set(
            (col - cols/2) * spacing,
            0,
            (row - rows/2) * spacing
          );
          
          chair.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'chair'
          };
          
          this.scene.add(chair);
          this.participantObjects.push(chair);
          
          // ××¤×§×˜ ×–×•×”×¨ ×œ×–×•×›×™×
          if (isWinner) {
            this.addGlowEffect(chair);
          }
        });
      }

      createSpaceEffect() {
        const radius = 15;
        
        this.participants.forEach((participant, index) => {
          // ×—×œ×•×§×” ×¡×¤×™×¨×œ×™×ª
          const angle = (index / this.participants.length) * Math.PI * 4;
          const distance = radius * Math.sqrt(index / this.participants.length);
          
          const starGeometry = new THREE.SphereGeometry(0.3, 8, 8);
          const isWinner = this.winners.some(w => w.id === participant.id);
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          
          let starColor = 0xFFFFFF;
          if (isWinner) {
            starColor = 0xFFD700;
          } else if (!isAvailable) {
            starColor = 0x444444;
          }
          
          const starMaterial = new THREE.MeshLambertMaterial({ 
            color: starColor,
            transparent: true,
            opacity: isAvailable || isWinner ? 1.0 : 0.3
          });
          
          const star = new THREE.Mesh(starGeometry, starMaterial);
          star.position.set(
            Math.cos(angle) * distance,
            (Math.random() - 0.5) * 10,
            Math.sin(angle) * distance
          );
          
          star.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'star',
            orbitSpeed: 0.01 + Math.random() * 0.02
          };
          
          this.scene.add(star);
          this.participantObjects.push(star);
          
          if (isWinner) {
            this.addPulseEffect(star);
          }
        });
      }

      createMagicEffect() {
        const rows = Math.ceil(Math.sqrt(this.participants.length));
        const cols = Math.ceil(this.participants.length / rows);
        const spacing = 2.5;
        
        this.participants.forEach((participant, index) => {
          const row = Math.floor(index / cols);
          const col = index % cols;
          
          // ×‘×§×‘×•×§ ×©×™×§×•×™
          const bottleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 2, 8);
          const isWinner = this.winners.some(w => w.id === participant.id);
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          
          const hue = (index / this.participants.length) * 360;
          let bottleColor = new THREE.Color().setHSL(hue / 360, 0.7, 0.5);
          
          if (isWinner) {
            bottleColor = new THREE.Color(0xFFD700);
          } else if (!isAvailable) {
            bottleColor = new THREE.Color(0x333333);
          }
          
          const bottleMaterial = new THREE.MeshLambertMaterial({ 
            color: bottleColor,
            transparent: true,
            opacity: isAvailable || isWinner ? 0.8 : 0.3
          });
          
          const bottle = new THREE.Mesh(bottleGeometry, bottleMaterial);
          bottle.position.set(
            (col - cols/2) * spacing,
            1,
            (row - rows/2) * spacing
          );
          
          bottle.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'bottle'
          };
          
          this.scene.add(bottle);
          this.participantObjects.push(bottle);
          
          if (isWinner) {
            this.addBubblingEffect(bottle);
          }
        });
      }

      createAdventureEffect() {
        const formation = this.calculateBattleFormation(this.participants.length);
        
        this.participants.forEach((participant, index) => {
          const pos = formation[index];
          
          const warriorGeometry = new THREE.ConeGeometry(0.3, 1.5, 6);
          const isWinner = this.winners.some(w => w.id === participant.id);
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          
          let warriorColor = 0x8B4513; // ×—×•×
          if (isWinner) {
            warriorColor = 0xFFD700; // ×–×”×‘
          } else if (!isAvailable) {
            warriorColor = 0x444444; // ××¤×•×¨
          }
          
          const warriorMaterial = new THREE.MeshLambertMaterial({ 
            color: warriorColor,
            transparent: true,
            opacity: isAvailable || isWinner ? 1.0 : 0.5
          });
          
          const warrior = new THREE.Mesh(warriorGeometry, warriorMaterial);
          warrior.position.set(pos.x, 0.75, pos.y);
          
          warrior.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'warrior'
          };
          
          this.scene.add(warrior);
          this.participantObjects.push(warrior);
          
          if (isWinner) {
            this.addSwordEffect(warrior);
          }
        });
      }

      createNatureEffect() {
        this.participants.forEach((participant, index) => {
          const x = (Math.random() - 0.5) * 30;
          const z = (Math.random() - 0.5) * 30;
          
          // ×’×–×¢ ×¢×¥
          const trunkGeometry = new THREE.CylinderGeometry(0.2, 0.3, 2, 8);
          const trunkMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
          const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
          trunk.position.set(x, 1, z);
          
          // ×¢×œ×•×•×”
          const leavesGeometry = new THREE.SphereGeometry(1, 8, 8);
          const isWinner = this.winners.some(w => w.id === participant.id);
          const isAvailable = this.availableParticipants.some(p => p.id === participant.id);
          
          let leavesColor = 0x228B22; // ×™×¨×•×§
          if (isWinner) {
            leavesColor = 0xFFD700; // ×–×”×‘
          } else if (!isAvailable) {
            leavesColor = 0x556B2F; // ×™×¨×•×§ ×›×”×”
          }
          
          const leavesMaterial = new THREE.MeshLambertMaterial({ 
            color: leavesColor,
            transparent: true,
            opacity: isAvailable || isWinner ? 0.8 : 0.4
          });
          
          const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
          leaves.position.set(x, 3, z);
          
          trunk.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'tree-trunk'
          };
          
          leaves.userData = { 
            isParticipant: true,
            participantId: participant.id,
            participantName: participant.name,
            type: 'tree-leaves'
          };
          
          this.scene.add(trunk);
          this.scene.add(leaves);
          this.participantObjects.push(trunk);
          this.participantObjects.push(leaves);
          
          if (isWinner) {
            this.addTreeGlowEffect(leaves);
          }
        });
      }

      calculateBattleFormation(count) {
        const formation = [];
        const rows = Math.ceil(Math.sqrt(count));
        const spacing = 2;
        
        for (let i = 0; i < count; i++) {
          const row = Math.floor(i / rows);
          const col = i % rows;
          formation.push({
            x: (col - rows/2) * spacing + (Math.random() - 0.5) * 0.5,
            y: (row - Math.ceil(count/rows)/2) * spacing + (Math.random() - 0.5) * 0.5
          });
        }
        
        return formation;
      }

      // ××¤×§×˜×™× × ×•×¡×¤×™×
      addGlowEffect(object) {
        const glowGeometry = object.geometry.clone();
        const glowMaterial = new THREE.MeshBasicMaterial({
          color: 0xFFD700,
          transparent: true,
          opacity: 0.3
        });
        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
        glow.scale.multiplyScalar(1.2);
        object.add(glow);
        
        // ×× ×™××¦×™×™×ª ×¤×¢×™××”
        object.userData.glowPulse = 0;
      }

      addPulseEffect(object) {
        object.userData.pulse = {
          scale: 1,
          direction: 1,
          speed: 0.02
        };
      }

      addBubblingEffect(object) {
        const bubbleCount = 3;
        for (let i = 0; i < bubbleCount; i++) {
          const bubbleGeometry = new THREE.SphereGeometry(0.1, 4, 4);
          const bubbleMaterial = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF,
            transparent: true,
            opacity: 0.6
          });
          const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
          bubble.position.set(
            (Math.random() - 0.5) * 0.5,
            Math.random() * 2 + 1,
            (Math.random() - 0.5) * 0.5
          );
          bubble.userData.bubble = {
            speed: Math.random() * 0.02 + 0.01,
            startY: bubble.position.y
          };
          object.add(bubble);
        }
      }

      addSwordEffect(object) {
        const swordGeometry = new THREE.CylinderGeometry(0.05, 0.05, 2, 4);
        const swordMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
        const sword = new THREE.Mesh(swordGeometry, swordMaterial);
        sword.position.y = 2;
        sword.rotation.z = Math.PI / 4;
        object.add(sword);
      }

      addTreeGlowEffect(object) {
        const lightCount = 3;
        for (let i = 0; i < lightCount; i++) {
          const lightGeometry = new THREE.SphereGeometry(0.1, 4, 4);
          const lightMaterial = new THREE.MeshBasicMaterial({
            color: 0xFFD700,
            transparent: true,
            opacity: 0.8
          });
          const light = new THREE.Mesh(lightGeometry, lightMaterial);
          const angle = (i / lightCount) * Math.PI * 2;
          light.position.set(
            Math.cos(angle) * 1.5,
            Math.sin(angle * 2) * 0.5,
            Math.sin(angle) * 1.5
          );
          light.userData.fairy = {
            angle: angle,
            speed: 0.02,
            radius: 1.5
          };
          object.add(light);
        }
      }

      formatDisplayName(fullName) {
        const displayMode = document.getElementById('nameDisplay').value;
        
        switch(displayMode) {
          case 'first':
            return fullName.split(' ')[0];
          case 'initials':
            return fullName.split(' ').map(part => part.charAt(0)).join('.');
          case 'numbers':
            const participant = this.participants.find(p => p.name === fullName);
            return participant ? `#${participant.id + 1}` : fullName;
          default:
            return fullName;
        }
      }

      randomizePositions() {
        if (this.participantObjects.length === 0) return;
        
        this.participantObjects.forEach(object => {
          object.position.x += (Math.random() - 0.5) * 2;
          object.position.z += (Math.random() - 0.5) * 2;
        });
        
        this.showNotification('×”××™×§×•××™× ×¢×•×¨×‘×‘×•!', 'info');
      }

      animate() {
        this.animationId = requestAnimationFrame(() => this.animate());
        
        // ×¢×“×›×•×Ÿ ×× ×™××¦×™×•×ª
        this.updateAnimations();
        
        // ×¨×™× ×“×•×¨ ×”×§× ×‘×¡ ×”×¨××©×™
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
        
        // ×¨×™× ×“×•×¨ ××¡×š ××œ×
        if (this.stageRenderer && this.stageScene && this.stageCamera) {
          this.stageRenderer.render(this.stageScene, this.stageCamera);
        }
      }

      updateAnimations() {
        const time = Date.now() * 0.001;
        
        this.participantObjects.forEach(object => {
          // ××¤×§×˜ ×¤×¢×™××”
          if (object.userData.pulse) {
            const pulse = object.userData.pulse;
            pulse.scale += pulse.direction * pulse.speed;
            if (pulse.scale > 1.3 || pulse.scale < 0.8) {
              pulse.direction *= -1;
            }
            object.scale.setScalar(pulse.scale);
          }
          
          // ××¤×§×˜ ×–×•×”×¨
          if (object.userData.glowPulse !== undefined) {
            object.userData.glowPulse += 0.05;
            if (object.children.length > 0) {
              object.children[0].material.opacity = 0.3 + Math.sin(object.userData.glowPulse) * 0.2;
            }
          }
          
          // ××¡×œ×•×œ ×›×•×›×‘×™×
          if (object.userData.type === 'star' && object.userData.orbitSpeed) {
            const radius = Math.sqrt(object.position.x ** 2 + object.position.z ** 2);
            const angle = Math.atan2(object.position.z, object.position.x) + object.userData.orbitSpeed;
            object.position.x = Math.cos(angle) * radius;
            object.position.z = Math.sin(angle) * radius;
          }
          
          // ×‘×•×¢×•×ª
          object.children.forEach(child => {
            if (child.userData.bubble) {
              const bubble = child.userData.bubble;
              child.position.y += bubble.speed;
              if (child.position.y > bubble.startY + 3) {
                child.position.y = bubble.startY;
              }
            }
            
            // ×¤×™×•×ª
            if (child.userData.fairy) {
              const fairy = child.userData.fairy;
              fairy.angle += fairy.speed;
              child.position.set(
                Math.cos(fairy.angle) * fairy.radius,
                Math.sin(fairy.angle * 3) * 0.5,
                Math.sin(fairy.angle) * fairy.radius
              );
            }
          });
        });
        
        // ×¡×™×‘×•×‘ ×¢×“×™×Ÿ ×©×œ ×”××¦×œ××”
        this.camera.position.x = Math.sin(time * 0.1) * 2;
        this.camera.lookAt(0, 0, 0);
      }

      async startDraw() {
        if (this.isDrawing || this.availableParticipants.length === 0) return;
        
        this.isDrawing = true;
        this.isPaused = false;
        
        const winnersCount = parseInt(document.getElementById('winnersCount').value) || 1;
        const drawSpeed = document.getElementById('drawSpeed').value;
        const drawName = document.getElementById('drawName').value || '×”×’×¨×œ×”';
        
        // ××¢×‘×¨ ×œ××¡×š ××œ×
        document.getElementById('fullscreenStage').classList.add('active');
        document.getElementById('stageTitle').textContent = `${drawName} - ×”×”×’×¨×œ×” ××ª×—×™×œ×”...`;
        
        // ×”×¢×ª×§×ª ×”×¡×¦× ×” ×œ××¡×š ××œ×
        this.copySceneToStage();
        
        // ×”×©××¢×ª ×¦×œ×™×œ ×”×ª×—×œ×”
        if (this.audioContext) {
          this.playDrawSound();
        }
        
        // ×‘×™×¦×•×¢ ×”×”×’×¨×œ×”
        await this.performDraw(winnersCount, drawSpeed);
      }

      copySceneToStage() {
        // × ×™×§×•×™ ×”×¡×¦× ×” ×©×œ ×”××¡×š ×”××œ×
        while(this.stageScene.children.length > 3) { // ×©××™×¨×” ×¢×œ ×ª××•×¨×” ×•×›×•×›×‘×™×
          this.stageScene.remove(this.stageScene.children[3]);
        }
        
        // ×”×¢×ª×§×ª ×›×œ ×”××•×‘×™×™×§×˜×™×
        this.participantObjects.forEach(object => {
          const clonedObject = object.clone();
          this.stageScene.add(clonedObject);
        });
        
        // ×”×ª×××ª ×”××¦×œ××”
        this.stageCamera.position.copy(this.camera.position);
        this.stageCamera.lookAt(0, 0, 0);
      }

      async performDraw(winnersCount, speed) {
        const speedSettings = {
          fast: { duration: 5000, cycles: 20 },
          normal: { duration: 10000, cycles: 40 },
          dramatic: { duration: 20000, cycles: 80 },
          epic: { duration: 30000, cycles: 120 }
        };
        
        const settings = speedSettings[speed];
        const selectedWinners = [];
        
        for (let round = 0; round < winnersCount; round++) {
          if (this.availableParticipants.length === 0) break;
          
          // ×‘×—×™×¨×ª ×–×•×›×”
          const winnerIndex = Math.floor(Math.random() * this.availableParticipants.length);
          const winner = this.availableParticipants[winnerIndex];
          
          // ×× ×™××¦×™×™×ª ×”×”×’×¨×œ×”
          await this.animateSelection(winner, settings, round);
          
          if (!this.isPaused) {
            selectedWinners.push(winner);
            this.availableParticipants.splice(winnerIndex, 1);
            this.addWinner(winner, round + 1);
          }
          
          if (round < winnersCount - 1 && !this.isPaused) {
            await this.sleep(1000);
          }
        }
        
        if (!this.isPaused) {
          await this.finishDraw(selectedWinners);
        }
        
        this.isDrawing = false;
      }

      async animateSelection(winner, settings, round) {
        const progressBar = document.getElementById('stageProgressBar');
        let progress = 0;
        const totalSteps = settings.cycles;
        
        for (let step = 0; step < totalSteps && !this.isPaused; step++) {
          progress = (step / totalSteps) * 100;
          progressBar.style.width = `${progress}%`;
          
          // ×”×“×’×©×ª ×¤×¨×™×˜×™× ××§×¨××™×™×
          this.highlightRandomParticipants(Math.max(1, Math.floor((totalSteps - step) / 10)));
          
          await this.sleep(settings.duration / settings.cycles);
        }
        
        // ×”×“×’×©×ª ×”×–×•×›×” ×”×¡×•×¤×™
        if (!this.isPaused) {
          this.highlightWinner(winner);
          
          if (this.audioContext) {
            this.playWinSound();
          }
          
          document.getElementById('stageTitle').textContent = 
            `ğŸ‰ ${this.formatDisplayName(winner.name)} ×–×›×”! ğŸ‰`;
        }
      }

      highlightRandomParticipants(count) {
        // ××™×¤×•×¡ ×”×“×’×©×•×ª ×§×•×“××•×ª
        this.stageScene.traverse(object => {
          if (object.userData.isParticipant) {
            object.material.color.setHex(object.userData.originalColor || 0x4FC3F7);
            object.scale.setScalar(1);
          }
        });
        
        // ×”×“×’×©×ª ×¤×¨×™×˜×™× ××§×¨××™×™×
        const availableIds = this.availableParticipants.map(p => p.id);
        const highlighted = [];
        
        for (let i = 0; i < count && i < availableIds.length; i++) {
          const randomId = availableIds[Math.floor(Math.random() * availableIds.length)];
          if (!highlighted.includes(randomId)) {
            highlighted.push(randomId);
            
            this.stageScene.traverse(object => {
              if (object.userData.participantId === randomId) {
                object.material.color.setHex(0xE040FB);
                object.scale.setScalar(1.2);
              }
            });
          }
        }
      }

      highlightWinner(winner) {
        this.stageScene.traverse(object => {
          if (object.userData.participantId === winner.id) {
            object.material.color.setHex(0xFFD700);
            object.scale.setScalar(1.5);
          } else if (object.userData.isParticipant) {
            object.material.color.setHex(0x666666);
            object.scale.setScalar(0.8);
          }
        });
      }

      addWinner(winner, position) {
        const winnerData = {
          ...winner,
          position: position,
          timestamp: new Date(),
          drawName: document.getElementById('drawName').value || '×”×’×¨×œ×”'
        };
        
        this.winners.push(winnerData);
        this.updateAll();
      }

      updateWinnersList() {
        const winnersList = document.getElementById('winnersList');
        winnersList.innerHTML = '';
        
        this.winners.forEach((winner, index) => {
          const winnerElement = document.createElement('div');
          winnerElement.className = 'winner-item';
          winnerElement.innerHTML = `
            <div class="winner-number">${winner.position}</div>
            <div>
              <div style="font-weight: bold; font-size: 16px;">${winner.name}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                ${winner.drawName} â€¢ ${winner.timestamp.toLocaleTimeString('he-IL')}
              </div>
            </div>
            <div style="font-size: 20px;">ğŸ†</div>
          `;
          winnersList.appendChild(winnerElement);
        });
      }

      async finishDraw(winners) {
        document.getElementById('stageTitle').textContent = 
          winners.length === 1 ? 
          `ğŸ‰ ${this.formatDisplayName(winners[0].name)} ×–×›×”! ğŸ‰` :
          `ğŸ‰ ×‘×¨×›×•×ª×™× ×• ×œ-${winners.length} ×”×–×•×›×™×! ğŸ‰`;
        
        if (this.audioContext) {
          this.playCelebrationSound();
        }
        
        await this.sleep(3000);
        
        setTimeout(() => {
          if (document.getElementById('fullscreenStage').classList.contains('active')) {
            this.exitFullscreen();
          }
        }, 10000);
      }

      pauseDraw() {
        this.isPaused = !this.isPaused;
        const pauseButton = document.getElementById('pauseButton');
        pauseButton.innerHTML = this.isPaused ? 'â–¶ï¸ ×”××©×š' : 'â¸ï¸ ×”×©×”×”';
      }

      stopDraw() {
        this.isPaused = true;
        this.isDrawing = false;
        this.exitFullscreen();
      }

      exitFullscreen() {
        document.getElementById('fullscreenStage').classList.remove('active');
        this.isPaused = false;
        this.isDrawing = false;
      }

      resetLottery() {
        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ ×”×ª×•×¦××•×ª?')) {
          this.winners = [];
          this.availableParticipants = [...this.participants];
          this.updateAll();
          this.showNotification('×”××¢×¨×›×ª ××•×¤×¡×” ×‘×”×¦×œ×—×”', 'success');
        }
      }

      enterFullscreen() {
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen();
        }
      }

      openFileDialog() {
        document.getElementById('fileInput').click();
      }

      // ×¤×•× ×§×¦×™×•×ª ×¡××•× ×“
      playDrawSound() {
        const buffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 2, this.audioContext.sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < data.length; i++) {
          const t = i / this.audioContext.sampleRate;
          data[i] = (Math.random() - 0.5) * 0.3 * Math.sin(t * 40 * Math.PI) * Math.exp(-t * 0.5);
        }
        
        this.playBuffer(buffer);
      }

      playWinSound() {
        const buffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 1, this.audioContext.sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < data.length; i++) {
          const t = i / this.audioContext.sampleRate;
          let sample = Math.sin(2 * Math.PI * 523.25 * t) * 0.3;
          sample += Math.sin(2 * Math.PI * 659.25 * t) * 0.3;
          sample += Math.sin(2 * Math.PI * 783.99 * t) * 0.3;
          sample *= Math.exp(-t * 1.5);
          data[i] = sample;
        }
        
        this.playBuffer(buffer);
      }

      playCelebrationSound() {
        const buffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 3, this.audioContext.sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < data.length; i++) {
          const t = i / this.audioContext.sampleRate;
          let sample = 0;
          
          const freqs = [261.63, 329.63, 392.00, 523.25];
          freqs.forEach(freq => {
            sample += Math.sin(2 * Math.PI * freq * t) * 0.2;
          });
          
          sample *= Math.exp(-t * 0.8);
          data[i] = sample;
        }
        
        this.playBuffer(buffer);
      }

      playBuffer(buffer) {
        const source = this.audioContext.createBufferSource();
        const gainNode = this.audioContext.createGain();
        
        source.buffer = buffer;
        gainNode.gain.value = 0.5;
        
        source.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        source.start();
      }

      handleKeyboard(event) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
          return;
        }
        
        switch(event.key.toLowerCase()) {
          case ' ':
            event.preventDefault();
            if (!this.isDrawing && this.availableParticipants.length > 0) {
              this.startDraw();
            }
            break;
          case 'escape':
            event.preventDefault();
            if (document.getElementById('fullscreenStage').classList.contains('active')) {
              this.exitFullscreen();
            }
            break;
          case 'p':
            event.preventDefault();
            if (this.isDrawing) {
              this.pauseDraw();
            }
            break;
          case 'r':
            event.preventDefault();
            this.randomizePositions();
            break;
        }
      }

      handleResize() {
        // ×¢×“×›×•×Ÿ ×’×“×œ×™ ×”×§× ×‘×¡
        const canvas = document.getElementById('main-canvas');
        this.camera.aspect = canvas.clientWidth / canvas.clientHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        
        this.stageCamera.aspect = window.innerWidth / window.innerHeight;
        this.stageCamera.updateProjectionMatrix();
        this.stageRenderer.setSize(window.innerWidth, window.innerHeight);
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          z-index: 3000;
          font-weight: bold;
          box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          animation: slideIn 0.3s ease-out;
        `;
        notification.textContent = message;
        
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
          }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.transition = 'all 0.3s ease-out';
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(100px)';
          setTimeout(() => {
            notification.remove();
            style.remove();
          }, 300);
        }, 3000);
      }

      sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // ×”×¤×¢×œ×ª ×”××¢×¨×›×ª
    document.addEventListener('DOMContentLoaded', () => {
      window.lotterySystem = new AdvancedLotterySystem();
    });
  </script>
</body>
</html>